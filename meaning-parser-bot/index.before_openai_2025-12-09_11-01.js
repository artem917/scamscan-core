const { Telegraf, Markup } = require('telegraf');
require('dotenv').config();

const botToken = process.env.BOT_TOKEN;

if (!botToken) {
    console.error('BOT_TOKEN Ð½Ðµ Ð·Ð°Ð´Ð°Ð½ Ð² .env');
    process.exit(1);
}

// ===== ÐÐ´Ð¼Ð¸Ð½Ñ‹ (Ð¿Ð¾Ð´Ð¼ÐµÐ½Ð¸Ð¼ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ID Ñ‡ÐµÑ€ÐµÐ· ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ) =====
const ADMINS = new Set([
    373229100,
    346722278
]);

function isAdmin(ctx) {
    return ctx.from && ADMINS.has(ctx.from.id);
}

// ÐšÐ°Ñ€Ñ‚Ð° Ð½Ð¸Ñˆ
const NICHES = {
    relationships: 'ÐžÑ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ',
    money: 'Ð”ÐµÐ½ÑŒÐ³Ð¸',
    psychology: 'ÐŸÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð¸Ñ',
    selfdev: 'Ð¡Ð°Ð¼Ð¾Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ',
    health: 'Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ',
    other: 'Ð”Ñ€ÑƒÐ³Ð¾Ðµ / ÐºÐ°ÑÑ‚Ð¾Ð¼'
};

// Ð’ Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ñ…Ñ€Ð°Ð½Ð¸Ð¼ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð½Ð¸ÑˆÑƒ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
const userNiches = new Map();

function getNicheLabel(key) {
    if (!key) return 'Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ð°';
    return NICHES[key] || 'Ð½Ðµ Ð·Ð°Ð´Ð°Ð½Ð°';
}

// Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ (Ð½Ð¸Ð¶Ð½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸)
const mainKeyboard = Markup.keyboard([
    ['ðŸ” Ð Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»Ð¸Ðº'],
    ['ðŸ§­ Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð¸ÑˆÑƒ', 'â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ']
]).resize();

const bot = new Telegraf(botToken);

function sendHelp(ctx) {
    return ctx.reply(
        'ÐšÐ°Ðº Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð›Ð°Ð¹Ñ‚-Ð²ÐµÑ€ÑÐ¸Ñ:\n\n' +
        '1) Ð¢Ñ‹ Ð·Ð°Ð´Ð°Ñ‘ÑˆÑŒ Ð½Ð¸ÑˆÑƒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ /set_niche (Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ, Ð´ÐµÐ½ÑŒÐ³Ð¸, Ð¿ÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð¸Ñ Ð¸ Ñ‚.Ð´.).\n' +
        '2) ÐŸÑ€Ð¸ÑÑ‹Ð»Ð°ÐµÑˆÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Ñ€Ð¾Ð»Ð¸Ðº Ð¸Ð»Ð¸ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ.\n' +
        '3) Ð‘Ð¾Ñ‚ Ñ€Ð°Ð·Ð±Ð¸Ñ€Ð°ÐµÑ‚ ÑÐ¼Ñ‹ÑÐ» Ð¸ Ð²Ñ‹Ð´Ð°Ñ‘Ñ‚ Ð½Ð°Ð±Ð¾Ñ€ Ð´ÐµÑ„Ð¸Ñ†Ð¸Ñ‚Ð½Ñ‹Ñ… Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð² Ð¸ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÐµÐ².\n\n' +
        'Ð¡ÐµÐ¹Ñ‡Ð°Ñ: Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ /start, /help, /set_niche Ð¸ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ‚ÐµÐºÑÑ‚Ð°. ' +
        'Ð˜Ð˜ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð¼ Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÐºÐ»ÑŽÑ‡Ð° OpenAI.\n\n' +
        'ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑÐ½Ð¸Ð·Ñƒ:\n' +
        'ðŸ” Ð Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»Ð¸Ðº â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¸ÑÐ»Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ð¸Ð»Ð¸ Ñ‚ÐµÐºÑÑ‚.\n' +
        'ðŸ§­ Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð¸ÑˆÑƒ â€” Ð²Ñ‹Ð±Ð¾Ñ€ Ð½Ð¸ÑˆÐ¸ (Ð¾Ñ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ, Ð´ÐµÐ½ÑŒÐ³Ð¸ Ð¸ Ñ‚.Ð¿.).\n' +
        'â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ â€” ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ.',
        mainKeyboard
    );
}

function sendNicheKeyboard(ctx) {
    return ctx.reply(
        'Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð½Ð¸ÑˆÑƒ, Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¹ ÑÐµÐ¹Ñ‡Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑˆÑŒ:',
        Markup.inlineKeyboard([
            [
                Markup.button.callback('ÐžÑ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ', 'niche:relationships'),
                Markup.button.callback('Ð”ÐµÐ½ÑŒÐ³Ð¸', 'niche:money')
            ],
            [
                Markup.button.callback('ÐŸÑÐ¸Ñ…Ð¾Ð»Ð¾Ð³Ð¸Ñ', 'niche:psychology'),
                Markup.button.callback('Ð¡Ð°Ð¼Ð¾Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ', 'niche:selfdev')
            ],
            [
                Markup.button.callback('Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ', 'niche:health'),
                Markup.button.callback('Ð”Ñ€ÑƒÐ³Ð¾Ðµ / ÐºÐ°ÑÑ‚Ð¾Ð¼', 'niche:other')
            ]
        ])
    );
}

// /start
bot.start((ctx) => {
    const userId = ctx.from.id;
    const nicheKey = userNiches.get(userId);
    const nicheLabel = getNicheLabel(nicheKey);

    ctx.reply(
        'ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ ÐŸÐ°Ñ€ÑÐµÑ€ ÑÐ¼Ñ‹ÑÐ»Ð¾Ð² (Ð»Ð°Ð¹Ñ‚-Ð²ÐµÑ€ÑÐ¸Ñ).\n\n' +
        'Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ñ Ð² ÑÑ‚Ð°Ð´Ð¸Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸. Ð¡ÐºÐ¾Ñ€Ð¾ ÑÐ¼Ð¾Ð³Ñƒ Ñ€Ð°Ð·Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»Ð¸ÐºÐ¸ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ñ‚ÑŒ Ð´ÐµÑ„Ð¸Ñ†Ð¸Ñ‚Ð½Ñ‹Ðµ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ð¸ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ð¿Ð¾Ð´ Ñ‚Ð²Ð¾ÑŽ Ð½Ð¸ÑˆÑƒ.\n\n' +
        'Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½Ð¸ÑˆÐ°: ' + nicheLabel + '.\n' +
        'ÐšÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ /set_niche Ð¸Ð»Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ Â«ðŸ§­ Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð¸ÑˆÑƒÂ» Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð½Ð¸ÑˆÑƒ, Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ‚Ñ‹ ÑÐµÐ¹Ñ‡Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑˆÑŒ.\n\n' +
        'ÐŸÐ¾ÐºÐ° Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¿Ñ€Ð¸ÑÐ»Ð°Ñ‚ÑŒ Ð»ÑŽÐ±Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð¸Ð»Ð¸ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Ñ€Ð¾Ð»Ð¸Ðº â€” Ñ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ñƒ, Ñ‡Ñ‚Ð¾ Ð¶Ð¸Ð² Ð¸ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÑŽ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚.',
        mainKeyboard
    );
});

// /help
bot.help((ctx) => {
    return sendHelp(ctx);
});

// /admin â€” Ñ‡ÐµÑ€Ð½Ð¾Ð²Ð°Ñ Ð°Ð´Ð¼Ð¸Ð½ÐºÐ°
bot.command('admin', (ctx) => {
    if (!isAdmin(ctx)) {
        return ctx.reply('Ð­Ñ‚Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð².', mainKeyboard);
    }

    const userId = ctx.from.id;
    const nicheKey = userNiches.get(userId);
    const nicheLabel = getNicheLabel(nicheKey);

    ctx.reply(
        'ÐÐ´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»ÑŒ (Ñ‡ÐµÑ€Ð½Ð¾Ð²Ð¸Ðº):\n\n' +
        'â€¢ Ð¢Ð²Ð¾Ð¹ Telegram ID: ' + userId + '\n' +
        'â€¢ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½Ð¸ÑˆÐ°: ' + nicheLabel + '\n\n' +
        'Ð’ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð²ÐµÑ€ÑÐ¸ÑÑ… Ð·Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÑƒÑ‚:\n' +
        'â€” ÑÑƒÑ‚Ð¾Ñ‡Ð½Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¸ Ð¸Ñ… Ð¾Ð±Ñ…Ð¾Ð´ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð²;\n' +
        'â€” ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ð¹;\n' +
        'â€” ÑÐ»ÑƒÐ¶ÐµÐ±Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹.',
        mainKeyboard
    );
});

// /set_niche â€” Ð²Ñ‹Ð±Ð¾Ñ€ Ð½Ð¸ÑˆÐ¸ Ñ‡ÐµÑ€ÐµÐ· inline-ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñƒ
bot.command('set_niche', (ctx) => {
    return sendNicheKeyboard(ctx);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð°Ð¶Ð°Ñ‚Ð¸Ð¹ Ð¿Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ñƒ Ð½Ð¸ÑˆÐ¸
bot.action(/^niche:(.+)$/, async (ctx) => {
    try {
        const nicheKey = ctx.match[1];
        const userId = ctx.from.id;

        userNiches.set(userId, nicheKey);

        const label = getNicheLabel(nicheKey);

        await ctx.answerCbQuery('ÐÐ¸ÑˆÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°');
        await ctx.editMessageText('ÐÐ¸ÑˆÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°: ' + label);
    } catch (err) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð½Ð¸ÑˆÐ¸:', err);
    }
});

// Ð›ÑŽÐ±Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ â€” Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð¼ÐµÐ½ÑŽ
bot.on('text', (ctx) => {
    const text = ctx.message.text || '';
    const userId = ctx.from.id;
    const nicheKey = userNiches.get(userId);
    const nicheLabel = getNicheLabel(nicheKey);

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð½Ð¸Ð¶Ð½ÐµÐ³Ð¾ Ð¼ÐµÐ½ÑŽ
    if (text === 'â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ') {
        return sendHelp(ctx);
    }

    if (text === 'ðŸ§­ Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð¸ÑˆÑƒ') {
        return sendNicheKeyboard(ctx);
    }

    if (text === 'ðŸ” Ð Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»Ð¸Ðº') {
        return ctx.reply(
            'Ð§Ñ‚Ð¾Ð±Ñ‹ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ€Ð¾Ð»Ð¸Ðº, Ð¿Ñ€Ð¸ÑˆÐ»Ð¸:\n' +
            'â€¢ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Ð²Ð¸Ð´ÐµÐ¾ (YouTube/Shorts, Ð¿Ð¾Ð·Ð¶Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ð»Ð¾Ñ‰Ð°Ð´ÐºÐ¸),\n' +
            'Ð¸Ð»Ð¸\n' +
            'â€¢ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ: Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº + 1â€“3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ð¾ Ñ‡Ñ‘Ð¼ Ñ€Ð¾Ð»Ð¸Ðº.\n\n' +
            'Ð¯ Ð¿Ð¾ÐºÐ° Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð·Ð°Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸, Ð½Ð¾ Ñ‚Ð°Ðº Ð±ÑƒÐ´ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹.',
            mainKeyboard
        );
    }

    // ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ â€” Ð·Ð°Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
    ctx.reply(
        'Ð¯ Ð¿Ð¾ÐºÐ° Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð·Ð°Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ¸, Ð½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» ðŸ‘Œ\n\n' +
        'Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð½Ð¸ÑˆÐ°: ' + nicheLabel + '\n\n' +
        'Ð¢Ñ‹ Ð½Ð°Ð¿Ð¸ÑÐ°Ð»:\n' + text + '\n\n' +
        'ÐÐ° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼ ÑÑ‚Ð°Ð¿Ðµ Ñ Ð±ÑƒÐ´Ñƒ Ñ€Ð°Ð·Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ Ñ‚Ð°ÐºÐ¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð²Ñ‹Ñ‚Ð°ÑÐºÐ¸Ð²Ð°Ñ‚ÑŒ Ð´ÐµÑ„Ð¸Ñ†Ð¸Ñ‚Ð½Ñ‹Ðµ ÑÐ¼Ñ‹ÑÐ»Ñ‹ Ð¸ ' +
        'Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð´ ÑÑ‚Ñƒ Ð½Ð¸ÑˆÑƒ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¸ Ð¸ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ñ€Ð¾Ð»Ð¸ÐºÐ¾Ð².',
        mainKeyboard
    );
});

// Ð¡Ñ‚Ð°Ñ€Ñ‚ÑƒÐµÐ¼ Ð±Ð¾Ñ‚Ð°
bot.launch().then(() => {
    console.log('Meaning-parser-bot Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½');
}).catch((err) => {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð±Ð¾Ñ‚Ð°:', err);
});

// ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
